<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音樂資料 API 端點</title>
    <!-- 外部 JavaScript 檔案，應包含 musicData 物件 -->
    <script src="https://liferlighdow.github.io/music/music-data.js"></script> 
    
    <script>
        // 輔助函式：從 URL 獲取查詢參數
        window.getQueryParam = function(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        };

        // 輔助函式：將字串處理為 CSV 安全格式
        window.escapeCsv = function(value) {
            if (value === null || value === undefined) {
                return '';
            }
            let stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return stringValue;
        };

        // 將所有類別的音樂資料扁平化
        window.flattenMusicData = function(musicDataObject) {
            const flatData = [];
            for (const category in musicDataObject) {
                if (musicDataObject.hasOwnProperty(category)) {
                    musicDataObject[category].forEach(song => {
                        flatData.push({
                            category: category,
                            title: song.title,
                            src: song.src,
                            cover: song.cover
                        });
                    });
                }
            }
            return flatData;
        };

        // 轉換為標題 CSV (單一列)
        window.convertToTitlesCsv = function(data) {
            const values = [];
            data.forEach(item => {
                values.push(window.escapeCsv(item.title));
            });
            return values.join(',');
        };

        // 轉換為封面網址 CSV (單一列，只留檔案名)
        window.convertToCoversCsv = function(data) {
            const values = [];
            data.forEach(item => {
                const filename = item.cover.split('/').pop();
                values.push(window.escapeCsv(filename));
            });
            return values.join(',');
        };

        // 轉換為音樂網址 CSV (單一列，只留檔案名)
        window.convertToSrcsCsv = function(data) {
            const values = [];
            data.forEach(item => {
                const filename = item.src.split('/').pop();
                values.push(window.escapeCsv(filename));
            });
            return values.join(',');
        };

        // 轉換為音樂類別 CSV (單一列)
        window.convertToCategoriesCsv = function(data) {
            const categories = new Set();
            data.forEach(item => categories.add(item.category));
            
            const values = [];
            Array.from(categories).sort().forEach(category => {
                values.push(window.escapeCsv(category));
            });
            return values.join(',');
        };

        // --- 核心邏輯：檢查參數並輸出 CSV 或提示訊息 ---
        const getParam = window.getQueryParam('get');
        let outputContent = '';

        if (getParam) {
            // 如果偵測到 'get' 參數，處理 CSV 輸出
            if (typeof musicData !== 'undefined' && musicData !== null) {
                try {
                    const allMusicData = window.flattenMusicData(musicData);

                    switch (getParam) {
                        case 'titles':
                            outputContent = window.convertToTitlesCsv(allMusicData);
                            break;
                        case 'covers':
                            outputContent = window.convertToCoversCsv(allMusicData);
                            break;
                        case 'srcs':
                            outputContent = window.convertToSrcsCsv(allMusicData);
                            break;
                        case 'categories':
                            outputContent = window.convertToCategoriesCsv(allMusicData);
                            break;
                        default:
                            outputContent = '錯誤：無效的 CSV 類型參數。請使用 titles, covers, srcs, 或 categories。';
                    }
                } catch (e) {
                    outputContent = `處理資料時發生錯誤：${e.message}`;
                    console.error("CSV 輸出模式錯誤:", e);
                }
            } else {
                outputContent = '錯誤：無法載入音樂資料。請檢查 music-data.js 檔案路徑。';
            }
            
            // 直接將 CSV 內容寫入文件，並關閉，確保純 CSV 輸出
            document.write(outputContent);
            document.close();
        } else {
            // 如果沒有 'get' 參數，則顯示 API 端點提示訊息
            outputContent = "此頁面為音樂資料 API 端點，請使用 URL 參數 (例如 ?get=titles) 獲取資料。";
            
            document.write(`
                <!DOCTYPE html>
                <html lang="zh-Hant">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>音樂資料 API 端點</title>
                    <style>
                        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f0f0f0; color: #333; text-align: center; }
                        div { padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                        code { background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px; }
                    </style>
                </head>
                <body>
                    <div>${outputContent}</div>
                </body>
                </html>
            `);
            document.close();
        }
    </script>
</head>
<body>
    <!-- 實際內容會由上方 JavaScript 產生，這個 body 標籤通常會被覆蓋或替代 -->
</body>
</html>
